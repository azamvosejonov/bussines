{% extends "base.html" %}

{% block title %}Scan Result - {{ item.name }}{% endblock %}

{% block content %}
<div class="welcome-section">
    <div class="text-center mb-4">
        <img src="{{ url_for('static', filename='images/logo.png') }}" alt="Business Logo" class="roles-logo mb-3">
        <h1><i class="fas fa-check-circle text-success"></i> QR Code Scanned</h1>
        <p class="text-muted">Item found successfully - process inventory transaction</p>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-md-10">
        <!-- Item Information Card -->
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-box"></i> Item Information</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <h4 class="text-primary">{{ item.name }}</h4>
                        {% if item.description %}
                        <p class="text-muted">{{ item.description }}</p>
                        {% endif %}

                        <div class="row mt-3">
                            <div class="col-md-6">
                                <p><strong>Category:</strong> {{ item.category or 'N/A' }}</p>
                                <p><strong>Current Stock:</strong>
                                    <span class="badge bg-info fs-6">{{ item.quantity }}</span>
                                </p>
                                <p><strong>Unit Price:</strong> ${{ "%.2f"|format(item.unit_price) }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Location:</strong> {{ item.location or 'N/A' }}</p>
                                <p><strong>Supplier:</strong> {{ item.supplier or 'N/A' }}</p>
                                <p><strong>Total Value:</strong> <strong>${{ "%.2f"|format(item.total_value) }}</strong></p>
                            </div>
                        </div>

                        {% if item.expiry_date %}
                        <div class="alert alert-warning mt-3">
                            <i class="fas fa-calendar-times"></i>
                            <strong>Expiry Date:</strong> {{ item.expiry_date.strftime('%Y-%m-%d') }}
                            {% if item.expiry_date < (datetime.now().date() + timedelta(days=30)) %}
                            <span class="badge bg-danger ms-2">Expires Soon!</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="p-3 bg-light rounded">
                            <i class="fas fa-qrcode fa-4x text-primary mb-3"></i>
                            <br>
                            <small class="text-muted">QR Code Active</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Transaction Form -->
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-exchange-alt"></i> Process Transaction</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('web.process_inventory_transaction', biz_id=business.id, item_id=item.id) }}">
                    {{ form.hidden_tag() }}
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.transaction_type.label(class="form-label") }}
                                {{ form.transaction_type(class="form-select") }}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                {{ form.quantity.label(class="form-label") }}
                                {{ form.quantity(class="form-control", type="number", min="1") }}
                                <div class="form-text">Quantity to add/remove/adjust</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        {{ form.reason.label(class="form-label") }}
                        {{ form.reason(class="form-control", placeholder="e.g., New stock delivery, Sale, Inventory count correction") }}
                        <div class="form-text">Reason for this transaction (optional but recommended)</div>
                    </div>

                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i>
                        <strong>Current Stock:</strong> {{ item.quantity }} units
                        <br>
                        <strong>Transaction Preview:</strong>
                        <span id="preview-text">Select transaction type and quantity</span>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('web.scan_qr_code', biz_id=business.id) }}" class="btn btn-outline-secondary me-md-2">
                            <i class="fas fa-arrow-left"></i> Scan Another
                        </a>
                        <a href="{{ url_for('web.manage_inventory', biz_id=business.id) }}" class="btn btn-outline-primary me-md-2">
                            <i class="fas fa-list"></i> View Inventory
                        </a>
                        {{ form.submit(class="btn btn-success") }}
                    </div>
                </form>
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="card mt-4">
            <div class="card-header">
                <h5><i class="fas fa-history"></i> Recent Transactions</h5>
            </div>
            <div class="card-body">
                {% set recent_transactions = item.transactions[:5] %}
                {% if recent_transactions %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Quantity</th>
                                <th>Previous</th>
                                <th>New</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in recent_transactions %}
                            <tr>
                                <td>{{ transaction.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>
                                    {% if transaction.transaction_type == 'in' %}
                                        <span class="badge bg-success">Stock In</span>
                                    {% elif transaction.transaction_type == 'out' %}
                                        <span class="badge bg-danger">Stock Out</span>
                                    {% else %}
                                        <span class="badge bg-warning">Adjustment</span>
                                    {% endif %}
                                </td>
                                <td>{{ transaction.quantity }}</td>
                                <td>{{ transaction.previous_quantity }}</td>
                                <td><strong>{{ transaction.new_quantity }}</strong></td>
                                <td>{{ transaction.reason or 'N/A' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center text-muted py-3">
                    <i class="fas fa-history fa-2x mb-2"></i>
                    <p>No transactions yet for this item.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Transaction preview
function updatePreview() {
    const type = document.getElementById('transaction_type').value;
    const quantity = parseInt(document.getElementById('quantity').value) || 0;
    const currentStock = {{ item.quantity }};

    let preview = '';

    if (type === 'in') {
        preview = `Stock will increase to ${currentStock + quantity}`;
    } else if (type === 'out') {
        if (quantity > currentStock) {
            preview = `⚠️ Insufficient stock! Cannot remove ${quantity} (only ${currentStock} available)`;
        } else {
            preview = `Stock will decrease to ${currentStock - quantity}`;
        }
    } else if (type === 'adjustment') {
        preview = `Stock will be adjusted to ${quantity}`;
    }

    document.getElementById('preview-text').innerHTML = preview;
}

document.getElementById('transaction_type').addEventListener('change', updatePreview);
document.getElementById('quantity').addEventListener('input', updatePreview);

// Initial preview
updatePreview();
</script>
{% endblock %}
