{% extends "base.html" %}

{% block title %}Sales Goals - {{ business.name }}{% endblock %}

{% block content %}
<div class="welcome-section">
    <h1><i class="fas fa-target"></i> Sales Goals Management</h1>
    <p class="text-muted">Set and track sales targets for employees</p>
</div>

<div class="row">
    <!-- Sales Goals List -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-list"></i> Sales Goals</h5>
            </div>
            <div class="card-body">
                {% if sales_goals %}
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Employee</th>
                                <th>Goal Type</th>
                                <th>Period</th>
                                <th>Target Amount</th>
                                <th>Achieved</th>
                                <th>Progress</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for goal in sales_goals %}
                            <tr>
                                <td>
                                    <strong>{{ goal.employee.name }}</strong>
                                    {% if goal.employee.position %}
                                    <br><small class="text-muted">{{ goal.employee.position }}</small>
                                    {% endif %}
                                </td>
                                <td class="text-capitalize">{{ goal.goal_type }}</td>
                                <td>
                                    {% if goal.goal_type == 'yearly' %}
                                        {{ goal.period_year }}
                                    {% elif goal.goal_type == 'monthly' %}
                                        {{ "%02d"|format(goal.period_month) }}/{{ goal.period_year }}
                                    {% else %}
                                        Q{{ goal.period_quarter }}/{{ goal.period_year }}
                                    {% endif %}
                                </td>
                                <td>${{ "%.2f"|format(goal.target_amount) }}</td>
                                <td>${{ "%.2f"|format(goal.achieved_amount) }}</td>
                                <td>
                                    {% set progress = (goal.achieved_amount / goal.target_amount * 100) if goal.target_amount > 0 else 0 %}
                                    <div class="progress" style="width: 80px;">
                                        <div class="progress-bar {{ 'bg-success' if progress >= 100 else 'bg-warning' if progress >= 75 else 'bg-danger' }}"
                                             role="progressbar"
                                             style="width: {{ progress }}%">
                                            {{ "%.0f"|format(progress) }}%
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-{{ 'success' if goal.status == 'completed' else 'primary' if goal.status == 'active' else 'secondary' }}">
                                        {{ goal.status.title() }}
                                    </span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-target fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No sales goals set yet</h5>
                    <p class="text-muted">Set goals for your employees to track their performance</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Set Sales Goal Form -->
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-plus"></i> Set Sales Goal</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('web.create_sales_goal', biz_id=business.id) }}">
                    {{ form.hidden_tag() }}
                    <div class="mb-3">
                        {{ form.employee_id.label(class="form-label") }}
                        {{ form.employee_id(class="form-select") }}
                    </div>
                    <div class="mb-3">
                        {{ form.goal_type.label(class="form-label") }}
                        {{ form.goal_type(class="form-select") }}
                    </div>
                    <div class="mb-3">
                        {{ form.period_year.label(class="form-label") }}
                        {{ form.period_year(class="form-control") }}
                    </div>
                    <div class="mb-3" id="month_field" style="display: none;">
                        {{ form.period_month.label(class="form-label") }}
                        {{ form.period_month(class="form-select") }}
                    </div>
                    <div class="mb-3" id="quarter_field" style="display: none;">
                        {{ form.period_quarter.label(class="form-label") }}
                        {{ form.period_quarter(class="form-select") }}
                    </div>
                    <div class="mb-3">
                        {{ form.target_amount.label(class="form-label") }}
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            {{ form.target_amount(class="form-control") }}
                        </div>
                    </div>
                    <div class="mb-3">
                        {{ form.target_quantity.label(class="form-label") }}
                        {{ form.target_quantity(class="form-control") }}
                    </div>
                    <div class="mb-3">
                        {{ form.notes.label(class="form-label") }}
                        {{ form.notes(class="form-control", rows=3) }}
                    </div>
                    {{ form.submit(class="btn btn-primary w-100") }}
                </form>
            </div>
        </div>

        <!-- Quick Stats -->
        {% if sales_goals %}
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Goal Statistics</h5>
            </div>
            <div class="card-body">
                {% set total_goals = sales_goals|length %}
                {% set completed_goals = sales_goals|selectattr('status', 'equalto', 'completed')|list|length %}
                {% set active_goals = sales_goals|selectattr('status', 'equalto', 'active')|list|length %}

                <div class="mb-3">
                    <strong>Total Goals:</strong>
                    <span class="float-end">{{ total_goals }}</span>
                </div>
                <div class="mb-3">
                    <strong>Active Goals:</strong>
                    <span class="float-end">{{ active_goals }}</span>
                </div>
                <div class="mb-3">
                    <strong>Completed Goals:</strong>
                    <span class="float-end">{{ completed_goals }}</span>
                </div>
                <div class="mb-3">
                    <strong>Completion Rate:</strong>
                    <span class="float-end">{{ "%.1f"|format(completed_goals / total_goals * 100) if total_goals > 0 else 0 }}%</span>
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const goalTypeSelect = document.querySelector('[name="goal_type"]');
    const monthField = document.getElementById('month_field');
    const quarterField = document.getElementById('quarter_field');

    function toggleFields() {
        const selectedType = goalTypeSelect.value;
        monthField.style.display = selectedType === 'monthly' ? 'block' : 'none';
        quarterField.style.display = selectedType === 'quarterly' ? 'block' : 'none';
    }

    goalTypeSelect.addEventListener('change', toggleFields);
    toggleFields(); // Initial call

    // Populate employee options
    const employeeSelect = document.querySelector('[name="employee_id"]');
    {% for employee in employees %}
    employeeSelect.innerHTML += '<option value="{{ employee.id }}">{{ employee.name }}</option>';
    {% endfor %}
});
</script>
{% endblock %}
